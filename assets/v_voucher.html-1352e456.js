import{_ as l,r as d,o as p,c as r,a as t,b as n,d as s,w as e,g as i,e as o}from"./app-a93bcaa0.js";const u={},h=o('<h1 id="v-voucher-验证" tabindex="-1"><a class="header-anchor" href="#v-voucher-验证" aria-hidden="true">#</a> v_voucher 验证</h1><h2 id="简述" tabindex="-1"><a class="header-anchor" href="#简述" aria-hidden="true">#</a> 简述</h2><p>当同一接口在短时间内被同一用户/IP/UA多次请求或异常时, 会触发风控, 如接口返回 <code>code</code> 为 <code>-352</code> 即 <code>风控校验失败</code>, 同时 <code>data</code> 中出现 <code>v_voucher</code> 字段, 响应头出现 <code>x-bili-gaia-vvoucher</code></p><p><code>v_voucher</code> 结构为字符串 <code>voucher_</code> 尾随一串以 <code>-</code> 为分隔符的小写 UUID</p><p><code>v_voucher</code> 可用于申请 captcha 验证码, 根据验证结果使用 <code>validate</code> 接口获取 <code>grisk_id</code> 作为被风控接口的 <code>gaia_vtoken</code> 与 Cookie 中的 <code>x-bili-gaia-vtoken</code> 即可恢复正常访问</p>',5),v=t("code",null,"User-Agent",-1),b=t("code",null,"Referer",-1),k=t("code",null,"Cookie",-1),_=t("code",null,"bili_ticket",-1),m=t("code",null,"b_nut",-1),g=t("code",null,"buvid3",-1),q=t("code",null,"buvid4",-1),f={href:"https://github.com/SocialSisterYi/bilibili-API-collect/issues/1067",target:"_blank",rel:"noopener noreferrer"},y=t("h2",{id:"操作流程",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#操作流程","aria-hidden":"true"},"#"),n(" 操作流程")],-1),x=o(`<li><p>快速以不正确的姿势请求接口, 直到返回 <code>v_voucher</code> 字段如下. 若 <code>data</code> 中没有 <code>v_voucher</code> 字段, 则检查响应头 <code>x-bili-gaia-vvoucher</code></p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">-352</span><span class="token punctuation">,</span>
  <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;风控校验失败&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;v_voucher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;voucher_84a8c3ce-33f5-4551-9552-9c6b13aa7938&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1),E=t("a",{href:"#%E4%BB%8E-v_voucher-%E7%94%B3%E8%AF%B7-captcha"},[n("请求 "),t("code",null,"register"),n(" 接口")],-1),A=t("code",null,"csrf",-1),B=t("code",null,"v_voucher",-1),C=t("code",null,"token",-1),j=t("code",null,"challenge",-1),w=t("code",null,"validate",-1),F=t("code",null,"seccode",-1),S=o('<li><p><a href="#%E4%BB%8E%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C%E8%8E%B7%E5%8F%96-grisk_id">请求 <code>validate</code> 接口</a>, 请求体传入 <code>challenge</code> <code>token</code> <code>validate</code> <code>seccode</code> <code>csrf</code>, 该接口返回 <code>grisk_id</code> 即 <code>gaia_vtoken</code> 与 <code>x-bili-gaia-vtoken</code></p></li><li><p>重新请求原接口, 原 URL 参数加入 <code>gaia_vtoken</code>, Cookie 加入 <code>x-bili-gaia-vtoken</code>, 即恢复正常</p></li>',2),N=t("h2",{id:"接口列表",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#接口列表","aria-hidden":"true"},"#"),n(" 接口列表")],-1),T=t("h3",{id:"从-v-voucher-申请-captcha",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#从-v-voucher-申请-captcha","aria-hidden":"true"},"#"),n(" 从 v_voucher 申请 captcha")],-1),O=t("blockquote",null,[t("p",null,"https://api.bilibili.com/x/gaia-vgate/v1/register")],-1),P=t("code",null,"v_voucher",-1),R=o(`<p><em>请求方式: POST</em></p><p><strong>正文参数(application/x-www-form-urlencoded):</strong></p><table><thead><tr><th>参数名</th><th>类型</th><th>内容</th><th>必要性</th><th>备注</th></tr></thead><tbody><tr><td>csrf</td><td>str</td><td>CSRF Token (位于 Cookie 的 bili_jct)</td><td>非必要</td><td></td></tr><tr><td>v_voucher</td><td>str</td><td>v_voucher</td><td>必要</td><td></td></tr></tbody></table><p><strong>JSON回复:</strong></p><p>根对象:</p><table><thead><tr><th>字段</th><th>类型</th><th>内容</th><th>备注</th></tr></thead><tbody><tr><td>code</td><td>num</td><td>返回值</td><td>0：成功<br>100000: 验证码获取失败</td></tr><tr><td>message</td><td>str</td><td>错误信息</td><td>默认为 0</td></tr><tr><td>ttl</td><td>num</td><td>1</td><td></td></tr><tr><td>data</td><td>obj</td><td>信息本体</td><td></td></tr></tbody></table><p><code>data</code> 对象:</p><table><thead><tr><th>字段</th><th>类型</th><th>内容</th><th>备注</th></tr></thead><tbody><tr><td>type</td><td>str</td><td>验证码类型</td><td>目前只有 <code>geetest</code></td></tr><tr><td>token</td><td>str</td><td>验证码 token</td><td>用于验证</td></tr><tr><td>geetest</td><td>obj</td><td>极验信息</td><td>若为 null 则说明该风控无法通过 captcha 解除</td></tr><tr><td>biliword</td><td>null</td><td></td><td></td></tr><tr><td>phone</td><td>null</td><td></td><td></td></tr><tr><td>sms</td><td>null</td><td></td><td></td></tr></tbody></table><p><code>geetest</code> 对象:</p><table><thead><tr><th>字段</th><th>类型</th><th>内容</th><th>备注</th></tr></thead><tbody><tr><td>gt</td><td>str</td><td>极验id</td><td>一般为固定值</td></tr><tr><td>challenge</td><td>str</td><td>极验KEY</td><td>由B站后端产生用于人机验证</td></tr></tbody></table><p><strong>示例:</strong></p><p>假设此处 <code>v_voucher</code> 为 <code>voucher_ecca35e6-36da-4f38-bd84-b3f420ea08c1</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token string">&quot;https://api.bilibili.com/x/gaia-vgate/v1/register&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;v_voucher=voucher_ecca35e6-36da-4f38-bd84-b3f420ea08c1&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><details><summary>查看响应示例:</summary><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;geetest&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e7abdb050c3d4609979f1685137e3bc0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;geetest&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;challenge&quot;</span><span class="token operator">:</span> <span class="token string">&quot;85118f8714875ca4c6d5641bb0ce9ddf&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;gt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ac597a4506fee079629df5d8b66dd4fe&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;biliword&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;phone&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sms&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h2 id="从验证结果获取-grisk-id" tabindex="-1"><a class="header-anchor" href="#从验证结果获取-grisk-id" aria-hidden="true">#</a> 从验证结果获取 grisk_id</h2><blockquote><p>https://api.bilibili.com/x/gaia-vgate/v1/validate</p></blockquote><p><em>请求方式: POST</em></p><p><strong>正文参数(application/x-www-form-urlencoded):</strong></p><table><thead><tr><th>参数名</th><th>类型</th><th>内容</th><th>必要性</th><th>备注</th></tr></thead><tbody><tr><td>csrf</td><td>str</td><td>CSRF Token (位于 Cookie 的 bili_jct)</td><td>非必要</td><td>若登陆则必要</td></tr><tr><td>challenge</td><td>str</td><td>验证码 challenge</td><td>必要</td><td></td></tr><tr><td>token</td><td>str</td><td>验证码 token</td><td>必要</td><td></td></tr><tr><td>validate</td><td>str</td><td>验证结果 validate</td><td>必要</td><td></td></tr><tr><td>seccode</td><td>str</td><td>验证结果 seccode</td><td>必要</td><td></td></tr></tbody></table><p><strong>JSON回复:</strong></p><p>根对象:</p><table><thead><tr><th>字段</th><th>类型</th><th>内容</th><th>备注</th></tr></thead><tbody><tr><td>code</td><td>num</td><td>返回值</td><td>0：成功<br>-111: csrf 校验失败<br>100003: 验证码过期</td></tr><tr><td>message</td><td>str</td><td>错误信息</td><td>默认为 0</td></tr><tr><td>ttl</td><td>num</td><td>1</td><td></td></tr><tr><td>data</td><td>obj</td><td>信息本体</td><td></td></tr></tbody></table><p><code>data</code> 对象:</p><table><thead><tr><th>字段</th><th>类型</th><th>内容</th><th>备注</th></tr></thead><tbody><tr><td>is_valid</td><td>num</td><td>验证结果</td><td>1：验证成功</td></tr><tr><td>grisk_id</td><td>str</td><td>gaia_vtoken</td><td>用于恢复正常访问</td></tr></tbody></table><p><strong>示例:</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token string">&quot;https://api.bilibili.com/x/gaia-vgate/v1/validate&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;challenge=e4fcb337b8c0427b56320f97e1064210&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;csrf=xxxxxxxxxxxxxxx&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;seccode=360f7b9cf75c74c68fbb7475416d0e0d|jordan&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;token=0e1e58bdff3d4b8aa298e346fed07eeb&quot;</span> <span class="token punctuation">\\</span>
--data-urlencode <span class="token string">&quot;validate=360f7b9cf75c74c68fbb7475416d0e0d&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details><summary>查看响应示例:</summary><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ttl&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;is_valid&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">&quot;grisk_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2e91cf2b67172ca8432fe7c9ab66a5c4&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details>`,27);function I(L,U){const a=d("RouterLink"),c=d("ExternalLinkIcon");return p(),r("div",null,[h,t("p",null,[n("若该情况出现在使用 Wbi 签名的接口中, 建议先检查 Wbi 签名是否正确. 若已检查 Wbi 签名或无需签名, 检查请求头中 "),v,n(),b,n(" 是否正常, 以及 "),k,n(" 中 "),s(a,{to:"/docs/misc/sign/bili_ticket.html"},{default:e(()=>[_]),_:1}),n(),s(a,{to:"/docs/misc/buvid3_4.html"},{default:e(()=>[m,n(),g,n(),q]),_:1}),n(" 等是否存在. 使用 captcha 是最后的选择, 因为 captcha 验证需要用户操作"),i(", 且这几天做验证码做的真的要疯了喵")]),t("p",null,[n("参见 "),t("a",f,[n("#1067"),s(c)])]),y,t("ol",null,[x,t("li",null,[t("p",null,[E,n(", 请求体传入 "),A,n(" 及 "),B,n(", 该接口返回与 "),s(a,{to:"/docs/login/login_action/#%E7%94%B3%E8%AF%B7captcha%E9%AA%8C%E8%AF%81%E7%A0%81"},{default:e(()=>[n("申请captcha验证码")]),_:1}),n(" 部分相同, 记录此处返回的 "),C,n(),j])]),t("li",null,[t("p",null,[n("按照 "),s(a,{to:"/docs/login/login_action/#%E9%AA%8C%E8%AF%81captcha%E9%AA%8C%E8%AF%81%E7%A0%81"},{default:e(()=>[n("验证captcha验证码")]),_:1}),n(" 进行验证, 记下验证结果的 "),w,n(" 与 "),F])]),S]),N,T,O,t("p",null,[n("注: 同一有效 "),P,n(" 只能请求一次, 请求完毕请立即 "),s(a,{to:"/docs/login/login_action/#%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81"},{default:e(()=>[n("进行验证")]),_:1}),n(" 防止过期失效")]),R])}const W=l(u,[["render",I],["__file","v_voucher.html.vue"]]);export{W as default};
